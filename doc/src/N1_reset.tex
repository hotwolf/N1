%###############################################################################
%# N1 - Manual - Reset, Exceptions, and Interrupts                             #
%###############################################################################
%#    Copyright 2018 - 2019 Dirk Heisswolf                                     #
%#    This file is part of the N1 project.                                     #
%#                                                                             #
%#    N1 is free software: you can redistribute it and/or modify               #
%#    it under the terms of the GNU General Public License as published by     #
%#    the Free Software Foundation, either version 3 of the License, or        #
%#    (at your option) any later version.                                      #
%#                                                                             #
%#    N1 is distributed in the hope that it will be useful,                    #
%#    but WITHOUT ANY WARRANTY; without even the implied warranty of           #
%#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
%#    GNU General Public License for more details.                             #
%#                                                                             #
%#    You should have received a copy of the GNU General Public License        #
%#    along with N1.  If not, see <http://www.gnu.org/licenses/>.              #
%###############################################################################
%# Version History:                                                            #
%#   March 4, 2019                                                             #
%#      - Initial release                                                      #
%###############################################################################

\section{Reset, Exceptions, and Interrupts}
\label{reset}

There are three hardware mechanisms in the N1 processor, which can stop the ongoing
program flow in order to react to an urgent hardware condition:
Reset, Exceptions and Interrupts.

\subsection{Reset}
\label{reset:rst}
A reset puts the entire sequential logic of the N1 into a defined initial state.
The \gls{ps} and the \gls{rs} become cleared and
the \hyperref[opcodes:freg:tc]{Throw Code register (TC)} is set to \texttt{0x0000} (see \tabref{reset:tc}).
After every reset, program execution will begin at address \texttt{0x0000}.
Any context of the previous program flow is lost.
Resets are generated by the system's hardware and occur at least once during power-up.

\subsection{Exceptions}
\label{reset:excpt}
Exceptions are a mechanism to handle error conditions. The are thrown either by hardware or software.
There are five error conditions, which are detected by the N1 hardware:
\begin{description}[style=nextline]
\item[\Gls{ps} overflow]
  A \gls{ps} overflow occurs when the capacity of the lower stack's RAM is exceeded
\item[\Gls{rs} stack underflow]
  A \gls{ps} underflow occurs when an instruction requires more arguments than
  available on the \gls{stack} and when a stack instruction would result in non-continuous filling
  of the stack.
\item[\Gls{rs} overflow]
  A \gls{rs} overflow occurs when the capacity of the lower stack's RAM is exceeded
\item[\Gls{rs} underflow]
  A \gls{rs} underflow occurs when an instruction requires more arguments than
  available on the \gls{rs}.
\item[Address out of range]
  This error condition indicates a memory access to a restricted address. This can either
  be caused by an instruction fetch or a data access
%\item[Undefined word]
%  This error condition is triggered whenever an undefined \gls{opcode} is executed or an
%  unimplemented \gls{freg} is accessed.
\end{description}

Any other error condition must be detected by software and thrown by writing to the
\hyperref[opcodes:freg:tc]{Throw Code register (TC)}.
Whenever an exception is thrown, the N1 processor keeps the associated \gls{tc}
(see \tabref{reset:tc} in the \hyperref[opcodes:freg:tc]{Throw Code register (TC)}.
In case of a \gls{ps} overflow or a \gls{rs} overflow, both stacks will be cleared.
Otherwise, the \gls{rs} and the lower content of the \gls{ps} will be kept,
allowing the \gls{excpt} to be caught by software.
The N1 processor will will then continue with a call to address \texttt{0x0000}.
%Exceptions can be triggered by software (see \secref{opcodes:freg:tc}).

The \glspl{tc} listed in \tabref{reset:tc} comply with the exception word set of
the ANS Forth standard~\cite{dpans94}.

\begingroup
\setlength{\LTleft}{-20cm plus -1fill}
\setlength{\LTright}{\LTleft}
\begin{center}
  \rowcolors{1}{gray!12}{white}                                         %set alternating row color
  \begin{longtable}{|c|l|}
    \rowcolor{white}
    \caption{Throw codes}
    \label{reset:tc} \\
    %Header
    \hline                                     
    \rowcolor{gray!25}
    \multicolumn{1}{|c|}{\textbf{\rule{0pt}{2.5ex}Throw Code}}     &  
    \multicolumn{1}{c|}{\textbf{\rule{0pt}{2.5ex}Condition}}\\
    \hline
    \endhead                               
    %Footers
    \hline
    \rowcolor{white}
    \multicolumn{2}{r}{\tiny{...continued}} \\
    \endfoot
    \hline
    \endlastfoot

    %Reset
    \texttt{0x0000} (0)                 &    
    Reset (no exception)                \\* \hline

    \texttt{0x0001} (1)                 &    
    No exception                        \\* \hline
       
    %Parameter stack overflow
    \texttt{0xFFFD} (-3)                &    
    Parameter stack overflow            \\* \hline

    %Parameter stack underflow
    \texttt{0xFFFC} (-4)                &    
      Parameter stack underflow         \\* \hline

    % stack overflow
    \texttt{0xFFFB} (-5)                &    
    Parameter stack overflow            \\* \hline

    %Parameter stack underflow
    \texttt{0xFFFA} (-6)                &    
    Parameter stack underflow           \\* \hline

    %Invalid memory address
    \texttt{0xFFF7} (-9)                &    
    Invalid memory address              \\* \hline

%    %Undefined word
%    \texttt{0xFFF3} (-13)                &    
%    Undefined word                       \\* \hline

  \end{longtable}
\end{center}  
\endgroup

\noindent
%The five hardware exceptions can be easily complemented by user defined software exceptions.
%Software exceptions can be thrown by pushing a unique \gls{tc} onto the \gls{ps} and performing
%a \gls{jump} to address \texttt{0x0000}.
%Hardware and software exceptions can then be handled by a common exception handler routine.

\subsection{Interrupts}
\label{reset:irq}
interrupts are an optional feature (see \secref{extensions:int})

%Interrupts are service requests which are generated by the peripheral hardware. They cause
%a temporary interruption of the ongoing program flow. 
%When an iterrupt occurs, the program counter is saved to the \gls{rs} and an interrupt service
%routine is executed. The location of the interrupt service routine is determined by the system's
%interrupt controller hardware. Further interrupts are automatically disabled during the execution
%of the interrupt service routine and must be manually reenabled by a control instruction
%(see \tabref{opcodes:ctrl:smpl}) before resuming the interrupted program flow.
